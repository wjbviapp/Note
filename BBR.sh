#!/bin/bash

FORCE="$1"
REBOOT="${2:-1}"

echo 'Build: tcp_bbr.ko'
# bash <(wget --no-check-certificate -qO- 'https://raw.githubusercontent.com/MoeClub/BBR/master/build.sh') "$FORCE"
bash <(echo "IyEvYmluL2Jhc2gKIyBCeSBNb2VDbHViCgpbICIkMSIgIT0gIi1mIiBdICYmIFsgISAtZiAiL2xpYi9tb2R1bGVzLyQodW5hbWUgLXIpL2tlcm5lbC9uZXQvaXB2NC90Y3BfYmJyLmtvIiBdICYmIGVjaG8gIlRoaXMgS2VybmVsIE5vdCBTdXBwb3J0IEJCUiBieSBEZWZhdWx0LiIgJiYgZXhpdCAxCgppbnN0YWxsRGVwPSgpCmZvciBkZXAgaW4gJChlY2hvICJnY2MsbWFrZSIgfHNlZCAncy8sL1xuL2cnKTsgZG8gY29tbWFuZCAtdiAiJHtkZXB9IiA+L2Rldi9udWxsIHx8IGluc3RhbGxEZXArPSgiJHtkZXB9Iik7IGRvbmUKbHMgLTEgIi91c3Ivc3JjIiB8Z3JlcCAtcSAiXmxpbnV4LWhlYWRlcnMtJCh1bmFtZSAtcikiIHx8IGluc3RhbGxEZXArPSgibGludXgtaGVhZGVycy0kKHVuYW1lIC1yKSIpCgppZiBbICIkeyNpbnN0YWxsRGVwW0BdfSIgLWd0IDAgXTsgdGhlbgogIGFwdCB1cGRhdGUKICBhcHQgaW5zdGFsbCAteSAiJHtpbnN0YWxsRGVwW0BdfSIKICBpZiBbICQ/IC1uZSAwIF07IHRoZW4KICAgIGVjaG8gIkluc3RhbGwgUGFja2FnZSBGYWlsLiIKICAgIGV4aXQgMQogIGZpCmZpCgprZXJuZWxWZXI9JCh1bmFtZSAtciB8Y3V0IC1kLSAtZjEgfGN1dCAtZC4gLWYxLTIpClsgISAtbiAiJHtrZXJuZWxWZXJ9IiBdICYmIGVjaG8gIk5vIEZvdW5kIEtlcm5lbCBWZXJzaW9uLiIgJiYgZXhpdCAxCgp3Z2V0IC1xTyAvdG1wL3RjcF9iYnIuYyAiaHR0cHM6Ly9naXQua2VybmVsLm9yZy9wdWIvc2NtL2xpbnV4L2tlcm5lbC9naXQvc3RhYmxlL2xpbnV4LmdpdC9wbGFpbi9uZXQvaXB2NC90Y3BfYmJyLmM/aD12JHtrZXJuZWxWZXJ9IgpbICQ/IC1uZSAwIF0gJiYgZWNobyAiSW52YWxpZCBLZXJuZWwgVmVyc2lvbi4iICYmIGV4aXQgMQoKIyB3Z2V0IC1xTyAvdG1wL01ha2VmaWxlICJodHRwczovL2dpdGh1Yi5jb20vTW9lQ2x1Yi9CQlIvcmF3L21hc3Rlci9NYWtlZmlsZSIKZWNobyAiYjJKcUxXMGdPajBnZEdOd1gySmljaTV2Q2dwaGJHdzZDZ2x0WVd0bElDMURJQzlzYVdJdmJXOWtkV3hsY3k5Z2RXNWhiV1VnTFhKZ0wySjFhV3hrSUUwOVlIQjNaR0FnYlc5a2RXeGxjeUJEUXoxZ2QyaHBZMmdnWjJOallBb0pDbU5zWldGdU9nb0piV0ZyWlNBdFF5QXZiR2xpTDIxdlpIVnNaWE12WUhWdVlXMWxJQzF5WUM5aWRXbHNaQ0JOUFdCd2QyUmdJR05zWldGdUNncHBibk4wWVd4c09nb0pZM0FnTFhKbUlIUmpjRjlpWW5JdWEyOGdMMnhwWWk5dGIyUjFiR1Z6TDJCMWJtRnRaU0F0Y21BdmEyVnlibVZzTDI1bGRDOXBjSFkwQ2dscGJuTnRiMlFnTDJ4cFlpOXRiMlIxYkdWekwyQjFibUZ0WlNBdGNtQXZhMlZ5Ym1Wc0wyNWxkQzlwY0hZMEwzUmpjRjlpWW5JdWEyOGdNajR2WkdWMkwyNTFiR3dnZkh3Z2RISjFaUW9KWkdWd2JXOWtJQzFoQ2dselpXUWdMV2tnSnk5dVpYUmNMbU52Y21WY0xtUmxabUYxYkhSZmNXUnBjMk12WkNjZ0wyVjBZeTl6ZVhOamRHd3VZMjl1WmdvSmMyVmtJQzFwSUNjdmJtVjBYQzVwY0hZMFhDNTBZM0JmWTI5dVoyVnpkR2x2Ymw5amIyNTBjbTlzTDJRbklDOWxkR012YzNselkzUnNMbU52Ym1ZS0NYZG9hV3hsSUZzZ0xYb2dJaVFrS0hObFpDQXRiaUFuSkNSd0p5QXZaWFJqTDNONWMyTjBiQzVqYjI1bUtTSWdYVHNnWkc4Z2MyVmtJQzFwSUNja0pHUW5JQzlsZEdNdmMzbHpZM1JzTG1OdmJtWTdJR1J2Ym1VS0NYTmxaQ0F0YVNBbkpDUmhYRzVsZEM1amIzSmxMbVJsWm1GMWJIUmZjV1JwYzJNZ1BTQm1jVnh1Ym1WMExtbHdkalF1ZEdOd1gyTnZibWRsYzNScGIyNWZZMjl1ZEhKdmJDQTlJR0ppY2x4dVhHNG5JQzlsZEdNdmMzbHpZM1JzTG1OdmJtWUtDWE41YzJOMGJDQXRjQW9LZFc1cGJuTjBZV3hzT2dvSmNtMGdMWEptSUM5c2FXSXZiVzlrZFd4bGN5OWdkVzVoYldVZ0xYSmdMMnRsY201bGJDOXVaWFF2YVhCMk5DOTBZM0JmWW1KeUxtdHZDZ2x6WldRZ0xXa2dKeTl1WlhSY0xtTnZjbVZjTG1SbFptRjFiSFJmY1dScGMyTXZaQ2NnTDJWMFl5OXplWE5qZEd3dVkyOXVaZ29KYzJWa0lDMXBJQ2N2Ym1WMFhDNXBjSFkwWEM1MFkzQmZZMjl1WjJWemRHbHZibDlqYjI1MGNtOXNMMlFuSUM5bGRHTXZjM2x6WTNSc0xtTnZibVlLQ1hkb2FXeGxJRnNnTFhvZ0lpUWtLSE5sWkNBdGJpQW5KQ1J3SnlBdlpYUmpMM041YzJOMGJDNWpiMjVtS1NJZ1hUc2daRzhnYzJWa0lDMXBJQ2NrSkdRbklDOWxkR012YzNselkzUnNMbU52Ym1ZN0lHUnZibVVLQ1hONWMyTjBiQ0F0Y0FvPSIgfGJhc2U2NCAtZCA+L3RtcC9NYWtlZmlsZQpbICQ/IC1uZSAwIF0gJiYgZWNobyAiSW52YWxpZCBNYWtlIEZpbGUuIiAmJiBleGl0IDEKCgojIGJicl9taW5fcnR0X3dpbl9zZWMKc2VkIC1pICdzfHN0YXRpYyBjb25zdCB1MzIgYmJyX21pbl9ydHRfd2luX3NlY1teO10qO3xzdGF0aWMgY29uc3QgdTMyIGJicl9taW5fcnR0X3dpbl9zZWMgPSAxMzt8ZycgL3RtcC90Y3BfYmJyLmMKCiMgYmJyX3Byb2JlX3J0dF9tb2RlX21zCnNlZCAtaSAnc3xzdGF0aWMgY29uc3QgdTMyIGJicl9wcm9iZV9ydHRfbW9kZV9tc1teO10qO3xzdGF0aWMgY29uc3QgdTMyIGJicl9wcm9iZV9ydHRfbW9kZV9tcyA9IDU2O3xnJyAvdG1wL3RjcF9iYnIuYwoKIyBiYnJfbWluX3Rzb19yYXRlCnNlZCAtaSAnc3xzdGF0aWMgY29uc3QgaW50IGJicl9taW5fdHNvX3JhdGVbXjtdKjt8c3RhdGljIGNvbnN0IGludCBiYnJfbWluX3Rzb19yYXRlID0gMjU2MDAwO3xnJyAvdG1wL3RjcF9iYnIuYwoKIyBiYnJfZ2FpbgpzZWQgLWkgJ3N8c3RhdGljIGNvbnN0IGludCBiYnJfaGlnaF9nYWluW147XSo7fHN0YXRpYyBjb25zdCBpbnQgYmJyX2hpZ2hfZ2FpbiA9IEJCUl9VTklUICogKDI4ODUgKiAyKSAvIDEwMDAgKyAxO3xnJyAvdG1wL3RjcF9iYnIuYwpzZWQgLWkgJ3N8c3RhdGljIGNvbnN0IGludCBiYnJfZHJhaW5fZ2FpblteO10qO3xzdGF0aWMgY29uc3QgaW50IGJicl9kcmFpbl9nYWluID0gQkJSX1VOSVQgKiAyICogMTAwMCAvIDI4ODU7fGcnIC90bXAvdGNwX2Jici5jCgojIGJicl9wYWNpbmdfZ2FpbgpzZWQgLWkgJzFoOzEhSDskIWQ7JHtnO3N8c3RhdGljIGNvbnN0IGludCBiYnJfcGFjaW5nX2dhaW5cW1xdW147XSo7fHN0YXRpYyBjb25zdCBpbnQgYmJyX3BhY2luZ19nYWluW10gPSBce1xuICAgICAgICBCQlJfVU5JVCAqIDE2IC8gOCxcbiAgICAgICAgQkJSX1VOSVQgKiA2IC8gOCxcbiAgICAgICAgQkJSX1VOSVQgKiAxNiAvIDgsICAgICAgICBCQlJfVU5JVCAqIDEwIC8gOCwgICAgICAgIEJCUl9VTklUICogMTQgLyA4LFxuICAgICAgICBCQlJfVU5JVCAqIDEwIC8gOCwgICAgICAgIEJCUl9VTklUICogMTIgLyA4LCAgICAgICAgQkJSX1VOSVQgKiAxMCAvIDhcblx9O3xnO30nIC90bXAvdGNwX2Jici5jCgojIGJicl9mdWxsX2J3X3RocmVzaApzZWQgLWkgJ3N8c3RhdGljIGNvbnN0IHUzMiBiYnJfZnVsbF9id190aHJlc2hbXjtdKjt8c3RhdGljIGNvbnN0IHUzMiBiYnJfZnVsbF9id190aHJlc2ggPSBCQlJfVU5JVCAqIDE3IC8gMTY7fGcnIC90bXAvdGNwX2Jici5jCgojIGJicl9sdF9idwpzZWQgLWkgJ3N8c3RhdGljIGNvbnN0IHUzMiBiYnJfbHRfYndfcmF0aW9bXjtdKjt8c3RhdGljIGNvbnN0IHUzMiBiYnJfbHRfYndfcmF0aW8gPSBCQlJfVU5JVCAvIDQ7fGcnIC90bXAvdGNwX2Jici5jCnNlZCAtaSAnc3xzdGF0aWMgY29uc3QgdTMyIGJicl9sdF9id19kaWZmW147XSo7fHN0YXRpYyBjb25zdCB1MzIgYmJyX2x0X2J3X2RpZmYgPSA4MDAwIC8gODt8ZycgL3RtcC90Y3BfYmJyLmMKCiMgbWFyawpzZWQgLWkgJ3N8Xk1PRFVMRV9ERVNDUklQVElPTihbXjtdKjt8TU9EVUxFX0RFU0NSSVBUSU9OKCJUQ1AgQkJSIChCb3R0bGVuZWNrIEJhbmR3aWR0aCBhbmQgUlRUKSBbU1Y6ICckKGRhdGUgKyVZLyVtLyVkKScgSW5zdGFsbGVkXSIpO3xnJyAvdG1wL3RjcF9iYnIuYwoKY2QgL3RtcAptYWtlICYmIG1ha2UgaW5zdGFsbAoKCgo=" |base64 -d) "$FORCE"
[ $? -ne 0 ] && echo "Build: Fail" && exit 1

echo 'Setting: limits.conf'
[ -f /etc/security/limits.conf ] && LIMIT='262144' && sed -i '/^\(\*\|root\)[[:space:]]*\(hard\|soft\)[[:space:]]*\(nofile\|memlock\)/d' /etc/security/limits.conf && echo -ne "*\thard\tmemlock\t${LIMIT}\n*\tsoft\tmemlock\t${LIMIT}\nroot\thard\tmemlock\t${LIMIT}\nroot\tsoft\tmemlock\t${LIMIT}\n*\thard\tnofile\t${LIMIT}\n*\tsoft\tnofile\t${LIMIT}\nroot\thard\tnofile\t${LIMIT}\nroot\tsoft\tnofile\t${LIMIT}\n\n" >>/etc/security/limits.conf
[ -f /etc/systemd/system.conf ] && sed -i 's/#\?DefaultLimitNOFILE=.*/DefaultLimitNOFILE=262144/' /etc/systemd/system.conf

echo 'Setting: sysctl.conf'
cat >/etc/sysctl.conf<<EOF
# This line below add by user.

fs.file-max = 104857600
fs.nr_open = 1048576
vm.overcommit_memory = 1
net.core.somaxconn = 65535
net.core.optmem_max = 262144
net.core.rmem_max = 8388608
net.core.wmem_max = 8388608
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.netdev_max_backlog = 65536
net.ipv4.tcp_mem = 4096 262144 8388608
net.ipv4.tcp_rmem = 4096 262144 8388608
net.ipv4.tcp_wmem = 4096 262144 8388608
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 16
net.ipv4.tcp_keepalive_intvl = 32
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_time = 900
net.ipv4.tcp_retries1 = 3
net.ipv4.tcp_retries2 = 8
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.ip_forward = 1

net.ipv4.icmp_echo_ignore_all = 1
net.ipv6.conf.all.disable_ipv6 = 1

net.ipv4.tcp_fastopen = 0
net.ipv4.tcp_fack = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_dsack = 1
net.ipv4.tcp_ecn = 0
net.ipv4.tcp_ecn_fallback = 1

net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

EOF


[ "$REBOOT" -eq "1" ] && reboot

